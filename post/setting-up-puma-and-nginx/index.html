<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Setting up Puma and Nginx | Lars Cromley</title><link rel=stylesheet href=https://cromleylabs.com/css/style.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/github.min.css><section class=section><div class=container><nav class=nav><div class=nav-left><a class=nav-item href=https://cromleylabs.com><h1 class="title is-4">Lars Cromley</h1></a></div><div class=nav-right><nav class="nav-item level is-mobile"><a class=level-item href=/about><span class=icon><i class="fa fa-id-badge"></i></span></a><a class=level-item href=/disclaimer><span class=icon><i class="fa fa-exclamation-circle"></i></span></a><a class=level-item href=https://github.com/callmeradical><span class=icon><i class="fa fa-github"></i></span></a><a class=level-item href=https://twitter.com/callmeradical><span class=icon><i class="fa fa-twitter"></i></span></a><a class=level-item href=/index.xml><span class=icon><i class="fa fa-rss"></i></span></a></nav></div></nav></div></section><section class=section><div class=container><h2 class="subtitle is-6">November 25, 2013</h2><h1 class=title>Setting up Puma and Nginx</h1><div class=content><p><em>(This article assumes familiarity with reverse proxy software such as Varnish or Nginx)</em></p><p>For those of you not familiar with puma you can check out more information <a href=http://puma.io>here - Puma.</a> and if that is too much to read, it can be summarized here…</p><ul><li>Puma is a very lightweight and incredibly fast web server that was built for speed and parallelism. For comparisions of other webservers check out the link above.</li></ul><p>As scability and multi-tenancy issues arise, the benefits of using a stack which utilizes a reverse proxy and web server tends to make more sense. The reverse proxy can feed into a pool of web apps as opposed to an instance of apache which would act as both load balancer and route the request to a single web server instance that would fork more processes to meet the demand. The diagram below generally depicts how this works.</p><p><strong>A reverse proxy: Example</strong></p><pre><code>                                +---&gt; web app 1 process --&gt; threads
                                |
[requests]&lt;--&gt;[reverse proxy server]--+---&gt; web app 2 process -&gt; threads
                                |
                                +---&gt; web app 3 process -&gt; threads
</code></pre><p><strong>Traditional Apache: Example</strong></p><pre><code>            +---  web app process fork
            |
[requests]-------  web app process fork
            |
            +--- web app process fork
</code></pre><p>There have been some debates and I have read conflicting reports of which way is better. Quite honestly I don&rsquo;t think we are ever going to find a one size fits all solution for these problems. Take a look at your application and try to figure out which makes sense for that project and put in your implementation, or do some research and benchmark each. I just want to put this out there so maybe some of you can get behind it.</p><h1 id=installing-puma>Installing Puma</h1><p>Installation is very quick and easy…</p><p>In any Rails 3+ app add the following to your Gemfile.</p><pre><code>gem     'puma', '~&gt; 2.5.1'
</code></pre><p>Then issue a quick <code>bundle install</code></p><p>When in that directory you can type <code>rails s</code> to start your app and you should be greated with something that looks similar to this:</p><pre><code>Puma starting in single mode...
blah blah blah blah
</code></pre><p>Congratulations Puma is installed!</p><h1 id=installing-nginx>Installing Nginx</h1><p>Nginx is the reverse proxy server we are going to be using. Mainly beceause we can utilize its <code>HttpProxyModule</code> to pass requests to any number of virtual hosts.</p><p>Installation varies from distro to distro I recommend compiling from source because generally what is available in the package managers is out of date.</p><p>If you would like to see these methods go ahead and <a href=http://wiki.nginx.org/install>look here - Nginx installation</a>.</p><h1 id=configuring-nginx>Configuring Nginx</h1><p>The particular configuration I use is to utilize the <code>upstream</code> directive to tell Nginx where to proxy parse the request to. Then we will add the virtual host and use <code>proxy_address</code> directive to tell Nginx to pass the request to the pool of processes defined in the <code>upstream</code> section.</p><p><strong><em>Warning: these instructions will vary from distro to distro</em></strong></p><p>First remove the default virtual hosts files.</p><p><code>sudo rm /etc/nginx/confi.d/default.conf</code></p><p>Next we have to create a new host config file. This will typically be located at <code>/etc/nginx/conf.d/project_name.conf</code> for our rails app fill in this file with this code, you can replace the sections labeled project_name with your own project name.</p><pre><code>upstream project_name {
  server unix:///var/run/project_name.sock;
}

server {
  listen 80;
  server_name project_name_url.com; # change to match your URL
  root /var/www/project_name/public; # I assume your app is located at this location

  location / {
    proxy_pass http://project_name; # match the name of upstream directive which is defined above the server block
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
</code></pre><p><em>note: You may need to modify the permissions of the /var/run directory if the user is not a member of wheel.</em></p><p>Then you can restart your Nginx server:</p><pre><code>sudo /etc/init.d/nginx restart
</code></pre><h1 id=starting-puma>Starting Puma</h1><p><code>cd</code> to your project&rsquo;s directory and bind Puma to a unix socket.</p><pre><code>RAILS_ENV=production bundle exec puma -e production -b unix:///var/run/project_name.sock
</code></pre><p>This is of course of little use to us outside of a testing scenario, we really want to run this as a daemon. We can do this very easily by supplying the <code>-d</code> parameter, like so:</p><pre><code>RAILS_ENV=production bundle exec puma -e production -d -b unix:///var/run/project_name.sock
</code></pre><p>And that is essentially it! You should now be up and running!</p><p>Managing puma requires a little bit of Unix-fu or command line mastery, some basic commands:</p><ul><li><p>This will show you the PID in use by puma.
<code>ps aux | grep puma</code></p></li><li><p>This will stop and and restart puma.
<code>kill -s SIGUSR2 #pid_number_from_ps_aux</code>
<em>note: this will kill itself and fork a new process with a new PID</em></p></li><li><p>This will terminate the puma daemon.
<code>kill -s SIGTERM #pid_number_from_ps_aux</code></p></li></ul><p>That is it for now, you can expect an in depth view of managing puma in the days to come. We will look at managing your pid&rsquo;s, sockets, and other built in functions in Puma.</p><p>Cheers!</p></div></div></section><section class=section><div class=container><aside><div id=disqus_thread></div></aside><script type=text/javascript>var disqus_shortname='callmeradical';(function(){var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div></section><section class=section><div class="container has-text-centered"><p>&copy; <a href=https://github.com/callmeradical>Lars Cromley</a> 2017</p></div></section><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/go.min.js></script><script type=text/javascript src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/languages/dockerfile.min.js></script><script>hljs.initHighlightingOnLoad();</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-159931755-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script>