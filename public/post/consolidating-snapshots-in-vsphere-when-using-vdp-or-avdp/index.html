  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Consolidating Snapshots in vSphere when using VDP or AVDP &middot; Lars Cromley </title>
    
    <link rel="stylesheet" type="text/css" href="http://callmeradical.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://callmeradical.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://callmeradical.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="http://callmeradical.com/favicon.ico">
    
    
    <script src="http://callmeradical.com/js/jquery.min.js"></script>
    <script src="http://callmeradical.com/js/main.min.js">
    </script>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/bg.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://callmeradical.com/" title="link to homepage for Lars Cromley"> <img src="http://callmeradical.com/images/logo.jpg" width="80" alt="Lars Cromley logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://callmeradical.com/"  title="link to homepage for Lars Cromley">Lars Cromley</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  Technologist, evangelist, and all around nerd. These thoughts are my own and do not reflect that of my employer.  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="http://callmeradical.com#blog" title="link to Lars Cromley blog" class="blog-button">Blog</a> </li>
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    
      
      <a href="http://twitter.com/callmeradical" title="@callmeradical on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
       
       
      
        
        <a href="https://github.com/callmeradical" title="callmeradical on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
       
       
      
        
        <a href="http://no.linkedin.com/in/larscromley/en" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
       
      
        
        <a href="mailto:lars@callmeradical.com" title="Email lars@callmeradical.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
       
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/bg.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://callmeradical.com/" title="link to homepage for Lars Cromley"> <img src="http://callmeradical.com/images/logo.jpg" width="80" alt="Lars Cromley logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://callmeradical.com/"  title="link to homepage for Lars Cromley">Lars Cromley</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  Technologist, evangelist, and all around nerd. These thoughts are my own and do not reflect that of my employer.  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="http://callmeradical.com/#blog" title="link to Lars Cromley blog" class="blog-button">Blog</a> </li></br>
                                
                                
                           </ul>
                        <nav class="cover-navigation navigation--social">
    
      
      <a href="http://twitter.com/callmeradical" title="@callmeradical on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
       
       
      
        
        <a href="https://github.com/callmeradical" title="callmeradical on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
       
       
      
        
        <a href="http://no.linkedin.com/in/larscromley/en" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
       
      
        
        <a href="mailto:lars@callmeradical.com" title="Email lars@callmeradical.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
       
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>Consolidating Snapshots in vSphere when using VDP or AVDP</h1>
          <span class="post-date">Mon, Nov 25, 2013</span>
          <p>Let me start by saying this, I can&rsquo;t stand vSphere Data Protection, however I feel that since it is offered for free, and there is little to no management or maintenance for the virtual appliance, I see no reason in keeping it from my vSphere environment. That being said I still prefer to use Veeam for reliable backups of our virtual infrastructure at least on a weekly basis.</p>

<p>So anyway lets get started. The few times that VDP really does give me problems is when I get a warning that tells me my VM snapshots need to be consolidated.</p>

<!-- more -->

<p>Like a good sysadmin, I listen to what the system is telling me and I attempt to do just that.</p>

<p>Inside the vSphere web interface I go to the VM, select actions, go to &lsquo;All vCenter Actions&rsquo;, navigate to snapshots, and click Consolidate. Voila!</p>

<p>Wrong.</p>

<p>I get a message stating that an unspecified file is locked. (Actual error message may vary, and at the bottom of this post you can see some of the messages that this applies to.)</p>

<p>Well, that isn&rsquo;t very helpful at all. So I shut down the VM in question and attempt to consolidate again. No joy.</p>

<p>After some googling, I found that this is really only specific to if you are using the VDP or AVDP appliance by VMware. The reason for this, exists in the process of by which VDP creates backups.
<em>Taken from vmware.com&rsquo;s knowledgebase</em></p>

<blockquote>
<p>Before backing up a virtual machine, the backup software takes a snapshot of the virtual machine. The backup software then mounts the virtual machine disk (.vmdk) on the backup appliance virtual machine to perform the backup. After the data is backed up, the appliance remove the .vmdk and the snapshot is deleted from the virtual machine.</p>

<p>In some cases, the backup appliance may not release the lock on the .vmdk after the backup process, and snapshot commit/consolidation operations fail due to the lock.</p>

<p>Note: The issue described in this article is applicable only when the backup appliance is running on a virtual machine/appliance.</p>
</blockquote>

<p>So if you are having a problem, try this&hellip;</p>

<p>To remove the .vmdk from the backup appliance and commit/consolidate the snapshot:</p>

<ol>
<li><p>Right-click the backup appliance virtual machine and click Edit Settings.</p></li>

<li><p>Check if the affected virtual machine&rsquo;s hard disk is mounted on the backup appliance virtual machine.</p></li>

<li><p>If the hard disk is mounted, select the hard disk and click Remove.</p></li>
</ol>

<p><em>Note:</em> Under Removal Options, ensure to select the Remove from virtual machine option.</p>

<p>Click OK to exit.</p>

        </div>
        <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Consolidating%20Snapshots%20in%20vSphere%20when%20using%20VDP%20or%20AVDP-http%3a%2f%2fcallmeradical.com%2fpost%2fconsolidating-snapshots-in-vsphere-when-using-vdp-or-avdp%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-2x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fcallmeradical.com%2fpost%2fconsolidating-snapshots-in-vsphere-when-using-vdp-or-avdp%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-2x"></span></a>
<a href="https://plus.google.com/share?url=http%3a%2f%2fcallmeradical.com%2fpost%2fconsolidating-snapshots-in-vsphere-when-using-vdp-or-avdp%2f" target="_blank" title="Google+" class="googleplus">
<span class="fa fa-google-plus-square fa-2x"></span></a>
<a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fcallmeradical.com%2fpost%2fconsolidating-snapshots-in-vsphere-when-using-vdp-or-avdp%2f&title=Consolidating%20Snapshots%20in%20vSphere%20when%20using%20VDP%20or%20AVDP" target="_blank" title="LinkedIn" class="linkedin">
<span class="fa fa-linkedin-square fa-2x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fcallmeradical.com%2fpost%2fconsolidating-snapshots-in-vsphere-when-using-vdp-or-avdp%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-2x"></span></a>
<a href="http://www.stumbleupon.com/submit?url=http%3a%2f%2fcallmeradical.com%2fpost%2fconsolidating-snapshots-in-vsphere-when-using-vdp-or-avdp%2f" target="_blank" title="StumbleUpon" class="stumbleupon"><span class="fa fa-stumbleupon fa-2x">
</span></a>
</div>

        



      </div>
    </div>

  </body>
  
</html>
