  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> Using Consul with Registrator &middot; Lars Cromley </title>
    
    <link rel="stylesheet" type="text/css" href="http://callmeradical.com/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://callmeradical.com/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://callmeradical.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="http://callmeradical.com/favicon.ico">
    
    
    <script src="http://callmeradical.com/js/jquery.min.js"></script>
    <script src="http://callmeradical.com/js/main.min.js"></script>

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68276982-1', 'auto');
      ga('send', 'pageview');

    </script>
    
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        "  style="background-image: url(/images/bg.jpg)" >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://callmeradical.com/" title="link to homepage for Lars Cromley"> <img src="http://callmeradical.com/images/logo.jpg" width="80" alt="Lars Cromley logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://callmeradical.com/"  title="link to homepage for Lars Cromley">Lars Cromley</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  Technologist, evangelist, and all around nerd. These thoughts are my own and do not reflect that of my employer.  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="http://callmeradical.com#blog" title="link to Lars Cromley blog" class="blog-button">Blog</a> </li>
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    
      
      <a href="http://twitter.com/callmeradical" title="@callmeradical on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
       
       
      
        
        <a href="https://github.com/callmeradical" title="callmeradical on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
       
       
      
        
        <a href="http://no.linkedin.com/in/larscromley/en" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
       
      
        
        <a href="mailto:lars@callmeradical.com" title="Email lars@callmeradical.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
       
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/bg.jpg)">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://callmeradical.com/" title="link to homepage for Lars Cromley"> <img src="http://callmeradical.com/images/logo.jpg" width="80" alt="Lars Cromley logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://callmeradical.com/"  title="link to homepage for Lars Cromley">Lars Cromley</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  Technologist, evangelist, and all around nerd. These thoughts are my own and do not reflect that of my employer.  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="http://callmeradical.com/#blog" title="link to Lars Cromley blog" class="blog-button">Blog</a> </li></br>
                                
                                
                           </ul>
                        <nav class="cover-navigation navigation--social">
    
      
      <a href="http://twitter.com/callmeradical" title="@callmeradical on Twitter"> <i class='fa fa-twitter'></i> <span class="label">Twitter</span> </a>
       
       
      
        
        <a href="https://github.com/callmeradical" title="callmeradical on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
       
       
      
        
        <a href="http://no.linkedin.com/in/larscromley/en" title="Linkedin"> <i class='fa fa-linkedin'></i> <span class="label">Linkedin</span> </a>
       
      
        
        <a href="mailto:lars@callmeradical.com" title="Email lars@callmeradical.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
       
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>Using Consul with Registrator</h1>
          <span class="post-date">Sat, Sep 10, 2016</span>
          <div class="feature">
          
            <img src=https://www.consul.io/assets/images/logo_large-475cebb0.png>
          
          </div>
          <p>Service discovery is not new, but I still see plenty of shops storing their configuration in the form of configuration files or hardcoded objects. Connecting to an instance of MySQL or Redis and hard coding connection strings beforehand doesn&rsquo;t allow one to take full advantage of dynamic resources and also doesn&rsquo;t allow for treating them as backing resources.</p>

<p>We are going to take a quick walk through setting up a <a href="consul.io">consul</a> cluster using docker-machine and have <a href="http://gliderlabs.com/registrator/latest/">registrator</a> dynamically create entries in consul&rsquo;s service catalog. This post goes on the assumption that you have the Docker toolkit installed/configured with VirtualBox and some working knowledge of docker in general.</p>

<p>The first thing we need to do is get some instances to play with.</p>

<pre><code class="language-bash">$ docker-machine create --driver virtualbox dev1
$ docker-machine create --driver virtualbox dev2
$ docker-machine create --driver virtualbox dev3
</code></pre>

<p>Once our machines are up and running we can then connect the Docker service by running:</p>

<pre><code class="language-bash">$ docker-machine env &lt;boxid&gt;
</code></pre>

<p>You will see some output similar to this:</p>

<pre><code class="language-bash">export DOCKER_TLS_VERIFY=&quot;1&quot;
export DOCKER_HOST=&quot;tcp://192.168.99.100:2376&quot;
export DOCKER_CERT_PATH=&quot;/Users/demo/.docker/machine/machines/dev1&quot;
export DOCKER_MACHINE_NAME=&quot;dev1&quot;
# Run this command to configure your shell: 
# eval $(docker-machine env dev1)
</code></pre>

<p>Now we have our shell configured for the first host we are going to work on. The last piece of information we will need before we can begin launching our consul service is the IP addresses of the machines or nodes.</p>

<pre><code class="language-bash">$ docker-machine ls
NAME   ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER    ERRORS
dev1   -        virtualbox   Running   tcp://192.168.99.100:2376           v1.12.1   
dev2   -        virtualbox   Running   tcp://192.168.99.101:2376           v1.12.1   
dev3   -        virtualbox   Running   tcp://192.168.99.102:2376           v1.12.1      
</code></pre>

<p>Now we can begin launching our consul service on each node.</p>

<pre><code class="language-bash">$ docker run -d --net=host \
 -e 'CONSUL_LOCAL_CONFIG={&quot;skip_leave_on_interrupt&quot;: true}' \
 --name=consul \
 consul agent -server \
 -bind=192.168.99.100 \
 -retry-join=192.168.99.101 \
 -bootstrap-expect=3 
</code></pre>

<p>For an explanation of the options when running the agent, I highly encourage you to look over the <a href="https://www.consul.io/docs/agent/options.html">consul documentation</a>. The team over at Hashicorp has done a really great job maintaining their docs.</p>

<p>When supplying the retry-join option, you can enter the first IP-address of the node, or another node. Meaning, you can either have all nodes point to the first node, or have each one point to another node, either method seems to work fine.</p>

<p><em>Note: If this is not the case someone please comment on accepted best practice.</em></p>

<p>Understanding consensus and Raft may not be necessary for this small walk-through, but if you are interested. I will do my best to explain it in another post, meanwhile, this is a great visualization and explanation of Raft consensus.</p>

<p><a href="http://thesecretlivesofdata.com/raft/">The Secret Lives of Data - Raft</a></p>

<p>Once you have launched Consul on each node, let&rsquo;s check the logs from the first consul container we launched. We should see our leader elected.</p>

<pre><code class="language-bash">$ eval $(docker-machine env dev1)
$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
f594e58e3cad        consul              &quot;docker-entrypoint.sh&quot;   4 minutes ago       Up 4 minutes                            backstabbing_brown
$ docker logs --tail 20 f594
    2016/09/10 19:03:38 [ERR] agent: coordinate update error: No cluster leader
    2016/09/10 19:03:52 [ERR] agent: failed to sync remote state: No cluster leader
    2016/09/10 19:04:02 [ERR] agent: coordinate update error: No cluster leader
    2016/09/10 19:04:17 [ERR] agent: failed to sync remote state: No cluster leader
    2016/09/10 19:04:29 [ERR] agent: coordinate update error: No cluster leader
    2016/09/10 19:04:30 [INFO] serf: EventMemberJoin: dev3 192.168.99.102
    2016/09/10 19:04:30 [INFO] consul: adding LAN server dev3 (Addr: 192.168.99.102:8300) (DC: dc1)
    2016/09/10 19:04:30 [INFO] consul: Attempting bootstrap with nodes: [192.168.99.100:8300 192.168.99.101:8300 192.168.99.102:8300]
    2016/09/10 19:04:31 [WARN] raft: Heartbeat timeout reached, starting election
    2016/09/10 19:04:31 [INFO] raft: Node at 192.168.99.100:8300 [Candidate] entering Candidate state
    2016/09/10 19:04:31 [INFO] raft: Election won. Tally: 2
    2016/09/10 19:04:31 [INFO] raft: Node at 192.168.99.100:8300 [Leader] entering Leader state
    2016/09/10 19:04:31 [INFO] consul: cluster leadership acquired
    2016/09/10 19:04:31 [INFO] consul: New leader elected: dev1
    2016/09/10 19:04:31 [INFO] raft: pipelining replication to peer 192.168.99.102:8300
    2016/09/10 19:04:31 [INFO] raft: pipelining replication to peer 192.168.99.101:8300
    2016/09/10 19:04:31 [INFO] consul: member 'dev1' joined, marking health alive
    2016/09/10 19:04:31 [INFO] consul: member 'dev2' joined, marking health alive
    2016/09/10 19:04:31 [INFO] consul: member 'dev3' joined, marking health alive
    2016/09/10 19:04:32 [INFO] agent: Synced service 'consul'
</code></pre>

<p>Let&rsquo;s test our consul installation first by logging into a node and attempting to query the API for some information.</p>

<pre><code class="language-bash">$ docker-machine ssh dev1
                        ##         .
                  ## ## ##        ==
               ## ## ## ## ##    ===
           /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;\___/ ===
      ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
           \______ o           __/
             \    \         __/
              \____\_______/
 _                 _   ____     _            _
| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __
| '_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ '__|
| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   &lt;  __/ |
|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|
Boot2Docker version 1.12.1, build HEAD : ef7d0b4 - Thu Aug 18 21:18:06 UTC 2016
Docker version 1.12.1, build 23cf638
$ curl localhost:8500/v1/catalog/nodes
</code></pre>

<p>After the curl you should be greeted with some output similar to this:</p>

<pre><code class="language-JSON">[{&quot;Node&quot;:&quot;dev1&quot;,&quot;Address&quot;:&quot;192.168.99.100&quot;,&quot;TaggedAddresses&quot;:{&quot;wan&quot;:&quot;192.168.99.100&quot;},&quot;CreateIndex&quot;:3,&quot;ModifyIndex&quot;:6},{&quot;Node&quot;:&quot;dev2&quot;,&quot;Address&quot;:&quot;192.168.99.101&quot;,&quot;TaggedAddresses&quot;:{&quot;wan&quot;:&quot;192.168.99.101&quot;},&quot;CreateIndex&quot;:4,&quot;ModifyIndex&quot;:7},{&quot;Node&quot;:&quot;dev3&quot;,&quot;Address&quot;:&quot;192.168.99.102&quot;,&quot;TaggedAddresses&quot;:{&quot;wan&quot;:&quot;192.168.99.102&quot;},&quot;CreateIndex&quot;:5,&quot;ModifyIndex&quot;:8}]
</code></pre>

<p>We can go ahead and proceed to launch Registrator on each node now.</p>

<pre><code class="language-bash">$ eval $(docker-machine env dev1)
$ docker run -d --name=registrator --net=host --volume=/var/run/docker.sock:/tmp/docker.sock gliderlabs/registrator consul://localhost:8500
</code></pre>

<p>And repeat for all three nodes. Registrator automatically registers and deregisters services for any Docker container by inspecting containers as they come online. Notice we are mounting the Docker socket in our Registrator container, this is how we are able to see transactions going through docker.</p>

<p>Now that Registrator and Consul are running on all nodes, let&rsquo;s launch a new service&hellip;</p>

<p>How about Redis?</p>

<pre><code class="language-bash">$ eval $(docker-machine env dev2)
$ docker run -d -p 6379:6379 --name redis redis
$ docker-machine ssh dev3
$ curl localhost:8500/v1/catalog/services
{&quot;consul&quot;:[],&quot;redis&quot;:[]}
$ curl localhost:8500/v1/catalog/service/redis
[{&quot;Node&quot;:&quot;dev2&quot;,&quot;Address&quot;:&quot;192.168.99.101&quot;,&quot;ServiceID&quot;:&quot;dev2:redis:6379&quot;,&quot;ServiceName&quot;:&quot;redis&quot;,&quot;ServiceTags&quot;:[],&quot;ServiceAddress&quot;:&quot;&quot;,&quot;ServicePort&quot;:6379,&quot;ServiceEnableTagOverride&quot;:false,&quot;CreateIndex&quot;:93,&quot;ModifyIndex&quot;:93}]
</code></pre>

<p>Great! Now we know information about where Redis is running and the ports that it is listening on. The documentation on Registrator is well maintained and is invaluable when working with this setup. Even though I was able to stand up a Redis instance and retrieve the service information, I still need to supply health checks and other information.</p>

<p>Say we were standing up Nginx. We want to declare a health check at the time the container is launched. We can tell Registrator about our service at the time of launch using environment variables. Like so:</p>

<pre><code class="language-bash">$ docker run -d --net=host -e SERVICE_CHECK_SCRIPT=&quot;curl --silent --fail localhost&quot; -e SERVICE_TAGS=&quot;urlprefix-/nginx&quot; -p 8081:80 -p 44300:443 nginx:1.10
</code></pre>

<p>If we check our consul entries we can see that there is a health now for Nginx</p>

<pre><code class="language-bash">$ curl localhost:8500/v1/health/service/nginx-80
[{&quot;Node&quot;:{&quot;Node&quot;:&quot;dev3&quot;,&quot;Address&quot;:&quot;192.168.99.102&quot;,&quot;TaggedAddresses&quot;:{&quot;wan&quot;:&quot;192.168.99.102&quot;},&quot;CreateIndex&quot;:5,&quot;ModifyIndex&quot;:145},&quot;Service&quot;:{&quot;ID&quot;:&quot;dev3:nginx:80&quot;,&quot;Service&quot;:&quot;nginx-80&quot;,&quot;Tags&quot;:[&quot;urlprefix-/nginx&quot;],&quot;Address&quot;:&quot;&quot;,&quot;Port&quot;:8081,&quot;EnableTagOverride&quot;:false,&quot;CreateIndex&quot;:145,&quot;ModifyIndex&quot;:145},&quot;Checks&quot;:[{&quot;Node&quot;:&quot;dev3&quot;,&quot;CheckID&quot;:&quot;serfHealth&quot;,&quot;Name&quot;:&quot;Serf Health Status&quot;,&quot;Status&quot;:&quot;passing&quot;,&quot;Notes&quot;:&quot;&quot;,&quot;Output&quot;:&quot;Agent alive and reachable&quot;,&quot;ServiceID&quot;:&quot;&quot;,&quot;ServiceName&quot;:&quot;&quot;,&quot;CreateIndex&quot;:5,&quot;ModifyIndex&quot;:5},{&quot;Node&quot;:&quot;dev3&quot;,&quot;CheckID&quot;:&quot;service:dev3:nginx:80&quot;,&quot;Name&quot;:&quot;Service 'nginx-80' check&quot;,&quot;Status&quot;:&quot;critical&quot;,&quot;Notes&quot;:&quot;&quot;,&quot;Output&quot;:&quot;&quot;,&quot;ServiceID&quot;:&quot;dev3:nginx:80&quot;,&quot;ServiceName&quot;:&quot;nginx-80&quot;,&quot;CreateIndex&quot;:145,&quot;ModifyIndex&quot;:145}]}]
</code></pre>

<p>It really can be that easy. There is a lot happening under the hood, but at its core, service discovery really can be that easy. Now when configuring my app, I can make some calls to a Rest API about service data I need for inside my application. I will try to follow up with another post on using <a href="https://github.com/eBay/fabio">Fabio</a> for load-balancing in this set-up.</p>

        </div>
        <div class="sharing">
<a href="https://twitter.com/intent/tweet?status=Using%20Consul%20with%20Registrator-http%3a%2f%2fcallmeradical.com%2fpost%2fusing-consul-with-registrator%2f" target="_blank" title="Follow me on Twitter" class="twitter">
<span class="fa fa-twitter-square fa-2x"></span></a>
<a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fcallmeradical.com%2fpost%2fusing-consul-with-registrator%2f" target="_blank" title="Join me on Facebook" class="facebook">
<span class="fa fa-facebook-square fa-2x"></span></a>
<a href="http://www.reddit.com/submit?url=http%3a%2f%2fcallmeradical.com%2fpost%2fusing-consul-with-registrator%2f" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-2x"></span></a>
</span></a>
</div>

        


<div id="disqus_thread"></div>

<script type="text/javascript">
  var disqusUsername = "callmeradical";

  (function() { 
  var d = document, s = d.createElement('script');

  s.src = '//' + disqusUsername + '.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </div>
    </div>

  </body>
  
</html>
